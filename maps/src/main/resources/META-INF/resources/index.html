<!DOCTYPE html>
<html>
<head>
    <style>
        /* Set the size of the div element that contains the map */
        #map {
            height: 768px;
            width: 768px;
        }
    </style>
</head>
<body onload="loadMap()">
<!--The div element for the map -->
<div id="map"></div>
<script>
    function loadMap() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (xhttp.readyState === 4 && xhttp.status === 200) {
                var apiKey = xhttp.responseText;

                var script = document.createElement('script');
                script.setAttribute('async', '');
                script.setAttribute('defer', '');
                script.setAttribute('src', 'https://maps.googleapis.com/maps/api/js?key=' + apiKey + '&callback=initMap');
                document.body.appendChild(script);
            }
        };

        xhttp.open("GET", "http://localhost:8080/google/maps/apiKey", true);
        xhttp.send(null);
    }

    // Initialize and add the map
    function initMap() {
        var map = new google.maps.Map(
            document.getElementById('map'), {
                zoom: 1.5,
                center: {lat: 0, lng: 0}
            });

        var geocoder = new google.maps.Geocoder;
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (xhttp.readyState === 4 && xhttp.status === 200) {
                // Typical action to be performed when the document is ready:
                var users = JSON.parse(xhttp.responseText);

                for (var i = 0; i < users.length; i++) {
                    (function (i) {
                        setTimeout(function () {
                            geocodeAddress(geocoder, map, users[i]);
                        }, (500 * (i + 1)));
                    })(i);
                }
            }
        };
        xhttp.open("GET", "http://localhost:8080/twitter/users", true);
        xhttp.send(null);
    }

    function geocodeAddress(geocoder, map, user) {
        geocoder.geocode({'address': user.location}, function(results, status) {
            if (status === 'OK') {
                if (results[0]) {
                    var marker = new google.maps.Marker({
                        map: map,
                        animation: google.maps.Animation.DROP,
                        position: results[0].geometry.location,
                    });

                    var infowindow = new google.maps.InfoWindow({
                        content: userCard(user),
                        maxWidth: 200
                    });

                    marker.addListener('mouseover', function() {
                        infowindow.open(map, marker);
                    });

                    marker.addListener('mouseout', function() {
                        infowindow.close();
                    });


                } else {
                    window.alert('No results found');
                }
            } else {
                window.alert('Geocoder failed due to: ' + status);
            }
        });
    }

    function userCard(user) {
        return '' +
            '@' + user.handle + '<br>' +
            user.fullName;
    }

</script>
</body>
</html>
